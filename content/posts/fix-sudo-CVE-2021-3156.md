---
title: "修复sudo漏洞（CVE-2021-3156）"
date: 2021-02-04T03:10:06Z
description:  "修复sudo漏洞（CVE-2021-3156）"
type: "post"
image: "https://note.youdao.com/yws/api/personal/file/BB659B06E2944806A2CD7D375EBFD7AF?method=download&shareKey=10e1d28d2d230f120165cb901aa3ea1a"
categories:
  - "linux"
  - "ansible"
tags:
  - "linux"
  - "ansible"

---
#### 修复步骤

- 原版本

```
sudo --version
Sudoers I/O plugin version 1.8.23
```

- 升级

```
wget https://www.sudo.ws/dist/sudo.tar.gz

tar -zxvf ./sudo.tar.gz

cd ./sudo-1.9.5p2

./configure --prefix=/usr              \
            --libexecdir=/usr/lib      \
            --with-secure-path         \
            --with-all-insults         \
            --with-env-editor          \
            --docdir=/usr/share/doc/sudo-1.9.5p2 \
            --with-passprompt="[sudo] password for %p: " && make
            
make install && ln -sfv libsudo_util.so.0.0.0 /usr/lib/sudo/libsudo_util.so.0
```

- 新版本

```
sudo --version
Sudoers audit plugin version 1.9.5p2
```

#### ansible-playbook

```
.
├── ansible.cfg
├── group_vars
│   └── all
├── hosts
├── roles
│   ├── common
│   │   └── tasks
│   │       └── main.yml
│   ├── k8s-prod
│   │   └── tasks
│   └── k8s-test
│       └── tasks
│           └── main.yml
└── site.yml
```

`roles/k8s-test/tasks/main.yml`

```
---
- name: get version
  shell: 'sudo --version'
  register: sudo_old_version

- name: echo old version
  debug: var=sudo_old_version.stdout_lines[0] verbosity=0

- name: scp sudo.tar.gz
  copy: 
    src: /srv/sudo.tar.gz
    dest: /tmp/

- name: unarchive sudo.tar.gz
  #shell: tar -xzvf /tmp/sudo.tar.gz -C /tmp
  unarchive:
    src: /tmp/sudo.tar.gz
    dest: /tmp/
    copy: no

- name: check gcc
  yum: 
    name: gcc
    state: present

- name: make sudo
  shell: 'cd /tmp/sudo-1.9.5p2/ && ./configure --prefix=/usr     \
            --libexecdir=/usr/lib      \
            --with-secure-path         \
            --with-all-insults         \
            --with-env-editor          \
            --docdir=/usr/share/doc/sudo-1.9.5p2 \
            --with-passprompt="[sudo] password for %p: " && make'
- name: make install sudo
  shell: 'cd /tmp/sudo-1.9.5p2/ && make install && ln -sfv libsudo_util.so.0.0.0 /usr/lib/sudo/libsudo_util.so.0'

- name: get version
  shell: 'sudo --version'
  register: sudo_new_version

- name: echo new version
  debug: var=sudo_new_version.stdout_lines[0] verbosity=0
```

site.yml

```
---
- name: install sudo 1.9.5
  hosts: all
  gather_facts: False
  remote_user: root

  roles:
    - common

#---
#- name: install sudo 1.9.5p2
#  hosts: k8s_test_servers
#  remote_user: root
#
#  roles:
#    - k8s-test
```

详细参考>`https://github.com/Vickey-Wu/fix-sudo-playbook`

#### 参考文章

>`http://www.linuxfromscratch.org/blfs/view/systemd/postlfs/sudo.html`
